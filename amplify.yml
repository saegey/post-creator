version: 1
backend:
  phases:
    preBuild:
      commands:
        - echo "Checking cache directory structure"
        - pwd
        - amplify -v # Print out the Amplify CLI version to confirm
        # Export environment variables for production
        - env | grep -e NEXT_PUBLIC_ >> .env.production
        - printenv
        - cat .env.production
    build:
      commands:
        # Push backend resources with Amplify CLI
        - amplifyPush --simple
frontend:
  phases:
    preBuild:
      commands:
        - echo "Checking cache directory structure"
        - pwd
        - amplify -v # Print out the Amplify CLI version to confirm
        # Install Node.js dependencies
        - npm ci
        # Export environment variables for production
        - env | grep -e NEXT_PUBLIC_ >> .env.production
        - printenv
        - cat .env.production
    build:
      commands:
        # Build the frontend application
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - $HOME/go/**/*
      - /usr/local/go/**/*
test:
  phases:
    preTest:
      commands:
        # Install Node.js dependencies
        - npm ci
        # Start the application using PM2
        - pm2 start npm -- start
        # Wait for the application to be ready
        - wait-on http://localhost:3000
    test:
      commands:
        # Run Cypress end-to-end tests
        - npx cypress run --reporter mochawesome --reporter-options "reportDir=cypress/report/mochawesome-report,overwrite=false,html=false,json=true,timestamp=mmddyyyy_HHMMss"
        # Run Cypress component tests
        - npx cypress run --reporter mochawesome --reporter-options "reportDir=cypress/report/mochawesome-report,overwrite=false,html=false,json=true,timestamp=mmddyyyy_HHMMss" --component
    postTest:
      commands:
        # Merge test reports
        - npx mochawesome-merge cypress/report/mochawesome-report/*.json > cypress/report/mochawesome.json
        # Stop PM2 processes
        - pm2 kill
  artifacts:
    baseDirectory: cypress
    configFilePath: "**/mochawesome.json"
    files:
      - "**/*.png"
      - "**/*.mp4"
  cache:
    paths:
      - cypress/report/mochawesome-report/*.json
