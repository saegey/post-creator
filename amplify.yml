version: 1
backend:
  phases:
    preBuild:
      commands:
        - env | grep -e NEXT_PUBLIC_ >> .env.production
        - cat .env.production
        - amplify pull --appId $AWS_APP_ID --envName $USER_BRANCH --yes
        - echo "Amplify pull completed"
    build:
      commands:
        # Push backend resources with Amplify CLI
        - amplifyPush --simple
frontend:
  phases:
    preBuild:
      commands:
        # Install Node.js dependencies
        - if [ $(git diff HEAD~1 package-lock.json | wc -l) -gt 0 ]; then echo "package-lock.json changed, running npm ci"; npm ci; else echo "No changes in package-lock.json, skipping npm ci"; fi
        # Export environment variables for production
        - env | grep -e NEXT_PUBLIC_ >> .env.production
    build:
      commands:
        # Build the frontend application
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - $HOME/go/**/*
      - /usr/local/go/**/*
      - .next/cache/**/* # Cache Next.js build artifacts
test:
  phases:
    preTest:
      commands:
        # Install Node.js dependencies
        - if [ $(git diff HEAD~1 package-lock.json | wc -l) -gt 0 ]; then echo "package-lock.json changed, running npm ci"; npm ci; else echo "No changes in package-lock.json, skipping npm ci"; fi
        # Start the application using PM2
        - pm2 start npm -- start
        # Wait for the application to be ready
        - wait-on http://localhost:3000
    test:
      commands:
        # Run Cypress end-to-end tests
        - npx cypress run --reporter mochawesome --reporter-options "reportDir=cypress/report/mochawesome-report,overwrite=false,html=false,json=true,timestamp=mmddyyyy_HHMMss"
        # Run Cypress component tests
        - npx cypress run --reporter mochawesome --reporter-options "reportDir=cypress/report/mochawesome-report,overwrite=false,html=false,json=true,timestamp=mmddyyyy_HHMMss" --component
    postTest:
      commands:
        # Merge test reports
        - npx mochawesome-merge cypress/report/mochawesome-report/*.json > cypress/report/mochawesome.json
        # Stop PM2 processes
        - pm2 kill
  artifacts:
    baseDirectory: cypress
    configFilePath: "**/mochawesome.json"
    files:
      - "**/*.png"
      - "**/*.mp4"
  cache:
    paths:
      - cypress/report/mochawesome-report/*.json
      - node_modules/**/*
      - $HOME/go/**/*
      - /usr/local/go/**/*
      - .next/cache/**/* # Cache Next.js build artifacts
      - /root/.cache/Cypress/**/*
